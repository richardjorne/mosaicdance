<!doctypehtml><meta content="width=device-width,initial-scale=1"name=viewport><title>TAIKO AR</title><style>body{margin:0;overflow:hidden;background:#111;font-family:'Courier New',monospace;color:#eee}#game{position:relative;width:100vw;height:100vh;display:flex;pointer-events:none}.zone{flex:1;border:2px solid #444;position:relative;display:flex;flex-direction:column;justify-content:center;align-items:center;background:rgba(0,0,0,.2);transition:border-color .2s}.spacer{width:10%;background:rgba(0,0,0,.5);border-left:1px dashed #555;border-right:1px dashed #555;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px}.thresh-line{position:absolute;top:60%;width:100%;height:2px;background:rgba(255,255,255,.3);border-bottom:1px dashed rgba(255,255,255,.1);z-index:5}.label-line{position:absolute;top:58%;right:10px;font-size:10px;color:#aaa}.label-group{text-align:center;z-index:10;pointer-events:none;text-shadow:2px 2px #000;margin-top:200px}.label{font-size:4vw;font-weight:700;color:#fff}.sub-label{font-size:1.5vw;color:#aaa;margin-top:5px}.swatch{width:30px;height:30px;border:2px solid #fff;margin:10px auto;background:#333;box-shadow:0 0 10px #000}.result{font-size:24px;font-weight:700;height:30px;color:#555;margin-top:10px}.result.active{color:#fff;text-shadow:0 0 10px #fff}.main-score{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:8vw;color:rgba(255,255,255,.8);font-weight:700;text-shadow:0 0 20px #fff;pointer-events:none;z-index:20;display:none}canvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;transform:scaleX(-1);cursor:crosshair;pointer-events:auto}#controls{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);padding:10px 20px;border-radius:20px;z-index:100;font-size:12px;display:flex;gap:15px;pointer-events:auto;align-items:center;border:1px solid #555}input[type=range]{vertical-align:middle;width:80px}button{padding:5px 15px;background:#0f0;border:none;font-weight:700;cursor:pointer;font-family:inherit;border-radius:4px}button.secondary{background:#555;color:#fff}#btn-flip{position:absolute;bottom:20px;right:20px;z-index:150;background:rgba(0,0,0,.6);color:#fff;border:2px solid #888;border-radius:50%;width:50px;height:50px;font-size:20px;line-height:50px;text-align:center;padding:0;cursor:pointer;pointer-events:auto;display:none;overflow:hidden}#btn-flip:active{background:rgba(255,255,255,.3)}.hit{animation:flash .1s}@keyframes flash{0%{background:rgba(255,255,255,.3)}100%{background:0 0}}#note-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5;overflow:hidden}.note{position:absolute;width:4vw;height:4vw;border-radius:50%;transform:translate(-50%,-50%);border:2px solid #fff;box-shadow:0 0 5px rgba(0,0,0,.5);will-change:transform,opacity}.note.left{background:#f55;left:25%}.note.right{background:#55f;left:75%}.hit-msg{position:absolute;font-size:4vw;font-weight:700;color:#fff;text-shadow:0 0 10px #fff;pointer-events:none;transform:translate(-50%,-50%);animation:floatUp .5s ease-out forwards}@keyframes floatUp{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-100%) scale(1.5)}}.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;color:#fff;text-align:center;pointer-events:auto;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:20px 10px;box-sizing:border-box}.overlay h1{font-size:clamp(18px,5vw,36px);margin-bottom:12px;color:#0f0;flex-shrink:0}.overlay p{font-size:clamp(12px,3vw,16px);max-width:90%;line-height:1.4;margin-bottom:16px;color:#ccc}.overlay .row{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;justify-content:center}.overlay .item{display:flex;flex-direction:column;align-items:center;gap:6px;font-size:clamp(11px,2.5vw,14px)}.overlay .circle{width:36px;height:36px;border-radius:50%;border:3px solid #fff}.overlay .circle.red{background:#f55}.overlay .circle.blue{background:#55f}.overlay .line-demo{width:100px;height:2px;background:rgba(255,255,255,.5);margin:10px 0;position:relative}.overlay .line-demo::after{content:'TRIGGER LINE';position:absolute;top:-15px;right:0;font-size:10px;color:#aaa}.overlay-close{position:absolute;top:10px;right:14px;background:0 0;border:2px solid #888;color:#ccc;font-size:22px;width:36px;height:36px;border-radius:50%;cursor:pointer;z-index:210;display:flex;align-items:center;justify-content:center;padding:0;line-height:1}.overlay-close:active{background:rgba(255,255,255,.2)}#calibration-overlay{pointer-events:none;background:0 0;justify-content:flex-start;padding-top:60px;overflow-y:visible}#calibration-msg{background:rgba(0,0,0,.7);padding:15px;border-radius:10px;pointer-events:auto;max-width:90vw;font-size:clamp(11px,2.8vw,14px);box-sizing:border-box}#calibration-msg h2{font-size:clamp(14px,4vw,22px);margin:0 0 10px 0}#calibration-msg p{font-size:clamp(11px,2.8vw,14px);max-width:100%;line-height:1.4}</style><canvas height=40 id=c width=50></canvas><div id=controls><button onclick=showTutorial() id=btn-next>NEXT</button> <button onclick='startGame("test")'style=display:none id=btn-start>START TEST</button></div><div class=overlay id=start-overlay style=display:flex;background:#000;z-index:9999;justify-content:center><div style=text-align:center><h1 style=font-size:clamp(28px,8vw,40px);margin-bottom:16px>TAIKO AR</h1><p style=font-size:clamp(13px,3.5vw,18px)>Camera access is required to play.</p><button onclick=init() style="font-size:clamp(16px,5vw,24px);padding:12px 24px">TAP TO START</button></div></div><div class=overlay id=calibration-overlay style=display:none><div id=calibration-msg style=position:relative><button onclick='document.getElementById("calibration-overlay").style.display="none"'class=overlay-close>Ã—</button><h2>CALIBRATION MODE</h2><p style=max-width:100%;text-align:left;margin-bottom:15px>1. Hold a colored object (bottle, paper, etc.) in the camera view.<br>2. <b>CLICK</b> the object on screen to select its unique color.<br>3. You will see <b>GREEN and RED mosaics</b> on screen.<br>4. Ensure the mosaics are exactly on your object, not on the background.<br>5. <b>Try AIR DRUMMING:</b> Lift object ABOVE the line to strike, then put down.<br>There should be a "hit" sound.<br>Make sure it's sensitive. If not, repeat from step 2 or adjust tolerance below.<div style="margin-top:15px;border-top:1px solid #555;padding-top:10px;text-align:center"><div style=font-weight:700;margin-bottom:10px>COLOR TOLERANCE: <span style=color:#f05;font-size:1.2em id=tol-display>50</span></div><div style=display:flex;justify-content:center;gap:20px><button onclick=adjustTol(-5) class=secondary style=width:60px;height:60px;font-size:30px;line-height:1>-</button> <button onclick=adjustTol(5) class=secondary style=width:60px;height:60px;font-size:30px;line-height:1>+</button></div><div style=font-size:.8em;color:#aaa;margin-top:5px>(Lower = Stricter, Higher = Looser)</div></div></div></div><div class=overlay id=tutorial-overlay style=display:none><h1>HOW TO PLAY</h1><div class=row><div class=item><div class="circle red"></div><span>LEFT DRUM</span></div><div class=item><div class="circle blue"></div><span>RIGHT DRUM</span></div></div><p><b>1.</b> Wait for the colored notes to reach the <b>TRIGGER LINE</b>.<br><b>2.</b> Strike UP across the line with your object to hit.<br><b>3.</b> You must bring the object back DOWN below the line to reset for the next hit.</p><button onclick='startGame("test")'>START TEST RUN</button></div><div class=overlay id=test-result-overlay style=display:none><button onclick='document.getElementById("test-result-overlay").style.display="none"'class=overlay-close>Ã—</button><h1>TEST RUN COMPLETE</h1><p>Great job! You've completed the calibration test.<br>Are you ready for the full song?<div class=row><button onclick=showTutorial() class=secondary>RE-READ TUTORIAL</button> <button onclick='startGame("full")'>START FULL GAME</button></div></div><div class=overlay id=countdown style=display:none;background:rgba(0,0,0,.8)><div id=countdown-text style="font-size:150px;font-weight:700;color:#fff;text-shadow:0 0 20px #f05">3</div></div><div id=game><div class=zone id=z0><div class=thresh-line></div><div class=label-line>TRIGGER LINE</div><div class=label-group></div></div><div class=spacer><div class=swatch id=target-swatch style=border-color:#fff></div></div><div class=zone id=z2><div class=thresh-line></div><div class=label-line>TRIGGER LINE</div><div class=label-group></div></div></div><button onclick=flipCamera() id=btn-flip title="Flip Camera"><span style=display:inline-block;transform:scale(.85);line-height:1>ðŸ”„</span></button><div class=main-score id=score>0</div><div id=note-container></div><script>const songData={bass:[0,66,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,1,48,1,0,3,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,5,43,1,0,1,43,1,0,3,43,1,0,21,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,19,43,1,0,5,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,1,48,1,0,3,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,1,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,21,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,19,43,1,0,5,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,1,48,1,0,3,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,1,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,21,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,19,43,1,0,5,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,1,48,1,0,3,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,1,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,5,43,1,0,1,43,1,0,3,43,1,0,5,43,1,0,1,43,1,0,1,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,5,43,1,0,1,43,1,0,3,43,1,0,5,43,1,0,1,43,1,0,1,45,1,0,3,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,3,45,1,0,3,45,1,0,1,45,1,0,1,45,1,0,1,48,1,0,3,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,3,48,1,0,3,48,1,0,1,48,1,0,1,48,1,0,1,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,5,43,1,0,1,43,1,0,3,43,1,0,5,43,1,0,1,43,1,0,1,42,1,0,3,43,1,0,1,43,1,0,3,43,1,0,5,43,1,0,1,43,1,0,3,43,1,0],drums:[36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,28,1,0,3,39,1,0,1,36,1,0,1,28,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,28,1,0,3,39,1,0,1,36,1,0,1,28,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,39,1,0,3,31,1,0,1,36,1,0,1,39,1,0,1,31,1,0,1,36,1,0,3,42,1,0,1,36,1,0,3,31,1,0,1,40,1,0,1,36,1,0,1,36,1,0,3,40,1],accomp:[0,448,57,32,60,32,55,64,57,32,60,32,55,64],melody:[0,56,86,2,83,2,81,2,79,2,83,4,0,18,74,2,86,2,83,2,81,2,79,2,83,4,0,20,86,2,83,2,81,2,79,2,83,2,81,2,79,4,0,4,76,4,74,4,0,4,86,2,83,2,81,2,79,2,83,2,81,2,79,4,0,4,76,4,74,4,71,2,74,2,86,2,83,2,81,2,79,2,83,4,0,18,74,2,86,2,83,2,81,2,79,2,83,4,0,14,74,2,74,4,86,2,83,2,81,2,79,2,83,2,81,2,79,4,0,4,76,4,74,4,0,4,86,2,83,2,81,2,79,2,83,2,81,2,79,4,0,4,76,4,74,3,0,1,83,4,81,4,79,4,81,6,0,2,76,6,0,2,81,3,0,1,83,3,0,1,81,3,0,1,79,3,0,1,81,6,0,2,76,4,0,2,76,2,81,3,0,1,83,3,0,1,81,3,0,1,79,3,0,1,81,6,0,2,79,6,0,2,81,3,0,1,83,3,0,1,79,3,0,1,76,2,79,2,81,3,0,1,81,2,83,2,81,2,79,4,79,6,0,8,76,2,79,2,81,2,81,2,81,2,83,2,79,4,0,16,76,2,79,2,81,2,81,2,81,2,83,2,79,4,0,20,81,2,81,2,81,2,83,2,79,4,0,18,79,2,81,2,83,2,79,4,0,2,79,2,81,2,83,2,79,4,0,8,79,4,81,2,81,2,81,2,83,2,79,4,0,16,76,2,79,2,81,2,81,2,81,2,83,2,79,4,0,16,76,2,79,2,81,2,81,2,81,2,83,2,79,4,0,18,79,2,81,2,83,2,79,4,0,2,79,2,81,2,83,2,79,4],right:[43,2,0,12,43,2,0,10,43,2,0,36,43,2,0,14,43,2,0,14,43,2,0,12,43,2,0,8,43,2,0,12,43,2,0,6,43,2,0,16,43,2,0,12,43,2,0,16,43,2,0,30,43,2,0,18,43,2,0,22,43,2,0,18,43,2,0,14,43,2,0,14,43,2,0,30,43,2,0,30,43,2,0,30,43,2,0,44,45,2,0,30,48,2,0,32,43,2,0,14,43,2,0,14,43,2,0,26,45,2,0,30,45,2,0,30,43,2,0,22,43,2,0,10,43,2],left:[0,32,43,2,0,12,43,2,0,10,43,2,0,16,43,2,0,24,43,2,0,24,43,2,0,14,43,2,0,8,43,2,0,10,43,2,0,24,43,2,0,36,43,2,0,16,43,2,0,38,43,2,0,10,43,2,0,26,43,2,0,22,43,2,0,32,43,2,0,28,43,2,0,14,43,2,0,26,45,2,0,34,48,2,0,28,43,2,0,16,43,2,0,10,43,2,0,34,45,2,0,30,45,2,0,26,43,2,0,18,43,2,0,10,43,2]},ctx=c.getContext("2d"),w=50,h=40,HIT_WINDOW=.45,CFG={tol:50,size:10,speed:20,offset:-.06},TRIGGER_Y_RATIO=.6,TRIGGER_Y=h*TRIGGER_Y_RATIO;let gameState="calibration",isPlaying=!1,startTime=0,score=0,combo=0,chartData=[],melodyData=[],songDuration=0;const TEMPO=160,SEC_PER_16TH=.09375;let currentFacingMode="environment",activeStream=null,videoElement=null,trackers=[{id:0,active:!1,color:{r:0,b:0,g:0},isTriggered:!1,lastTrigger:0},{},{id:2,active:!1,color:{r:0,b:0,g:0},isTriggered:!1,lastTrigger:0}];const mtof=e=>440*Math.pow(2,(e-69)/12),AUDIO={ctx:null,init:()=>{AUDIO.ctx||(AUDIO.ctx=new(window.AudioContext||window.webkitAudioContext)),"suspended"===AUDIO.ctx.state&&AUDIO.ctx.resume()},reset:async()=>{if(AUDIO.ctx){try{await AUDIO.ctx.close()}catch(e){}AUDIO.ctx=null}},playTone:(e,t,a,n="sine")=>{if(!AUDIO.ctx)return;const o=AUDIO.ctx.createOscillator(),r=AUDIO.ctx.createGain();o.connect(r),r.connect(AUDIO.ctx.destination),o.type=n,o.frequency.value=mtof(e),r.gain.setValueAtTime(.3,t),r.gain.exponentialRampToValueAtTime(.001,t+.9*a),o.start(t),o.stop(t+a)},playSaw:(e,t,a)=>{AUDIO.playTone(e,t,a,"sawtooth")},playNoise:(e,t)=>{if(!AUDIO.ctx)return;const a=AUDIO.ctx.sampleRate*t,n=AUDIO.ctx.createBuffer(1,a,AUDIO.ctx.sampleRate),o=n.getChannelData(0);for(let e=0;e<a;e++)o[e]=2*Math.random()-1;const r=AUDIO.ctx.createBufferSource();r.buffer=n;const i=AUDIO.ctx.createGain();i.connect(AUDIO.ctx.destination),r.connect(i),i.gain.setValueAtTime(.5,e),i.gain.exponentialRampToValueAtTime(.001,e+t),r.start(e)},playDrum:(e,t,a)=>{if(AUDIO.ctx)if(36===e||35===e){const e=AUDIO.ctx.createOscillator(),a=AUDIO.ctx.createGain();e.connect(a),a.connect(AUDIO.ctx.destination),e.frequency.setValueAtTime(150,t),e.frequency.exponentialRampToValueAtTime(.01,t+.1),a.gain.setValueAtTime(.8,t),a.gain.exponentialRampToValueAtTime(.001,t+.1),e.start(t),e.stop(t+.1)}else 38===e||40===e?AUDIO.playNoise(t,.1):AUDIO.playCymbal(t)},playCymbal:e=>{if(!AUDIO.ctx)return;const t=.05*AUDIO.ctx.sampleRate,a=AUDIO.ctx.createBuffer(1,t,AUDIO.ctx.sampleRate),n=a.getChannelData(0);for(let e=0;e<t;e++)n[e]=2*Math.random()-1;const o=AUDIO.ctx.createBufferSource();o.buffer=a;const r=AUDIO.ctx.createGain(),i=AUDIO.ctx.createBiquadFilter();i.type="highpass",i.frequency.value=5e3,o.connect(i),i.connect(r),r.connect(AUDIO.ctx.destination),r.gain.setValueAtTime(.4,e),r.gain.exponentialRampToValueAtTime(.001,e+.05),o.start(e)}};function scheduleParams(e){let t=[],a=0;for(let n=0;n<e.length;n+=2){const o=e[n],r=e[n+1]*SEC_PER_16TH;0!==o&&t.push({time:a,pitch:o,dur:r}),a+=r}return t}function parseSongData(){const e=scheduleParams(songData.bass),t=scheduleParams(songData.melody),a=scheduleParams(songData.accomp),n=scheduleParams(songData.drums),o=scheduleParams(songData.right),r=scheduleParams(songData.left);let i=[];o.forEach((e=>{i.push({...e,type:2,hit:!1})})),r.forEach((e=>{i.push({...e,type:0,hit:!1})})),i.sort(((e,t)=>e.time-t.time));let s=0;return[e,t,a,n].forEach((e=>{if(e.length>0){const t=e[e.length-1];t.time+t.dur>s&&(s=t.time+t.dur)}})),songDuration=s,{bg:{bass:e,melody:t,accomp:a,drums:n},chart:i}}function showTutorial(){isPlaying=!1,AUDIO.reset(),document.getElementById("note-container").innerHTML="",gameState="tutorial",document.getElementById("calibration-overlay").style.display="none",document.getElementById("btn-next").style.display="none",document.getElementById("tutorial-overlay").style.display="flex",document.getElementById("test-result-overlay").style.display="none"}function adjustTol(e){CFG.tol=Math.max(10,Math.min(400,parseInt(CFG.tol)+e));const t=document.getElementById("tol-display");t&&(t.innerText=CFG.tol)}async function startGame(e){console.log("startGame called with mode:",e),await AUDIO.reset(),setTimeout((()=>{document.getElementById("tutorial-overlay").style.display="none",document.getElementById("test-result-overlay").style.display="none";const t=document.getElementById("countdown"),a=document.getElementById("countdown-text");t.style.display="flex";let n=3;a.innerText=n;const o=setInterval((()=>{n--,n>0?a.innerText=n:(clearInterval(o),t.style.display="none",startActualGame(e))}),1e3)}),50)}function startActualGame(e){AUDIO.init(),gameState="test"===e?"test_game":"game",document.getElementById("controls").style.display="none",document.getElementById("score").style.display="block";const t=parseSongData();chartData=t.chart,startTime=AUDIO.ctx.currentTime+.1,isPlaying=!0,score=0,combo=0,updateScore(),t.bg.melody.forEach((e=>AUDIO.playTone(e.pitch,startTime+e.time,e.dur,"square"))),t.bg.bass.forEach((e=>AUDIO.playTone(e.pitch,startTime+e.time,e.dur,"triangle"))),t.bg.accomp.forEach((e=>AUDIO.playTone(e.pitch,startTime+e.time,e.dur,"sine"))),t.bg.drums.forEach((e=>AUDIO.playDrum(e.pitch,startTime+e.time,e.dur)));const a=document.getElementById("note-container");a.innerHTML="",chartData.forEach((e=>{const t=document.createElement("div");t.className="note "+(0===e.type?"left":"right"),t.style.display="none",a.appendChild(t),e.el=t}))}function ensureAudio(){AUDIO.init()}function updateScore(e){const t=document.getElementById("score");t&&(e?(t.innerText=e,setTimeout((()=>{isPlaying&&(t.innerText=score)}),500)):t.innerText=score)}function trigger(e){if(!AUDIO.ctx)return;const t=AUDIO.ctx.currentTime,a=document.getElementById("z"+e);if(a&&(a.classList.remove("hit"),a.offsetWidth,a.classList.add("hit")),!isPlaying)return void AUDIO.playCymbal(t);const n=t-startTime,o=chartData.filter((t=>t.type===e&&!t.hit));let r=null,i=1/0;for(let e of o){const t=e.time-n,a=Math.abs(t-CFG.offset);a<i&&(i=a,r=e)}if(r&&i<=HIT_WINDOW){r.hit=!0,score+=100,combo++;showHitEffect(0===e?"25%":"75%","60%","HIT!"),AUDIO.playCymbal(t),updateScore()}}async function init(){try{let e;if(AUDIO.ctx||(AUDIO.ctx=new(window.AudioContext||window.webkitAudioContext)),"suspended"===AUDIO.ctx.state&&await AUDIO.ctx.resume(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)e=await navigator.mediaDevices.getUserMedia({video:{facingMode:currentFacingMode,width:{ideal:320},height:{ideal:240}},audio:!1});else{if(!navigator.getUserMedia)throw new Error("Browser does not support camera access via getUserMedia.");e=await new Promise(((e,t)=>{navigator.getUserMedia({video:{facingMode:currentFacingMode,width:{ideal:320},height:{ideal:240}},audio:!1},e,t)}))}activeStream=e;const t=document.createElement("video");t.setAttribute("playsinline",""),t.srcObject=e,t.play(),videoElement=t,updateCanvasMirror();const a=document.getElementById("start-overlay");a&&(a.style.display="none"),document.getElementById("calibration-overlay").style.display="flex",document.getElementById("btn-flip").style.display="block",loop(t)}catch(e){console.error(e),alert("Camera access failed: "+e.message)}}function updateCanvasMirror(){document.getElementById("c").style.transform="scaleX(-1)"}async function flipCamera(){currentFacingMode="environment"===currentFacingMode?"user":"environment",activeStream&&activeStream.getTracks().forEach((e=>e.stop()));try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:currentFacingMode,width:{ideal:320},height:{ideal:240}},audio:!1});activeStream=e,videoElement&&(videoElement.srcObject=e,videoElement.play()),updateCanvasMirror()}catch(e){console.error("Failed to flip camera:",e),currentFacingMode="environment"===currentFacingMode?"user":"environment"}}function stopGameForTestResult(){console.log("Stopping game for test result..."),isPlaying=!1,AUDIO.ctx&&AUDIO.ctx.suspend(),gameState="test_result",document.getElementById("test-result-overlay").style.display="flex",document.getElementById("score").style.display="none"}function showHitEffect(e,t,a){const n=document.getElementById("note-container"),o=document.createElement("div");o.className="hit-msg",o.innerText=a,o.style.left=e,o.style.top=t,n.appendChild(o),setTimeout((()=>o.remove()),500)}function loop(e){ctx.drawImage(e,0,0,w,h);const t=CFG.offset*CFG.speed,a=TRIGGER_Y-HIT_WINDOW*CFG.speed-t,n=TRIGGER_Y+HIT_WINDOW*CFG.speed-t-a;ctx.fillStyle="rgba(255, 255, 255, 0.1)",ctx.fillRect(0,a,w,n),ctx.strokeStyle="rgba(255, 255, 255, 0.3)",ctx.strokeRect(0,a,w,n);const o=ctx.getImageData(0,0,w,h).data;let r={0:0,2:0};const i=Math.floor(h*TRIGGER_Y_RATIO);for(let e=0;e<o.length;e+=4){const t=e/4,a=t%w;if(Math.floor(t/w)>=i)continue;const n=o[e],s=o[e+1],c=o[e+2];if(trackers[0].active&&a>w/2){const t=trackers[0].color;Math.abs(n-t.r)+Math.abs(s-t.g)+Math.abs(c-t.b)<CFG.tol&&(r[0]++,o[e+1]=255)}if(trackers[2].active&&a<w/2){const t=trackers[2].color;Math.abs(n-t.r)+Math.abs(s-t.g)+Math.abs(c-t.b)<CFG.tol&&(r[2]++,o[e]=255)}}if(ctx.putImageData(new ImageData(o,w,h),0,0),[0,2].forEach((e=>{const t=r[e],a=trackers[e];if(a.active)if(t>parseInt(CFG.size)){const t=Date.now();!a.isTriggered&&t-a.lastTrigger>100&&(trigger(e),a.isTriggered=!0,a.lastTrigger=t)}else t<parseInt(CFG.size)/2&&a.isTriggered&&(a.isTriggered=!1)})),isPlaying&&AUDIO.ctx){const e=AUDIO.ctx.currentTime-startTime;"test_game"===gameState&&songDuration>0&&e>.2*songDuration&&(console.log("Test Mode Complete. Stopping game."),stopGameForTestResult()),chartData.forEach((t=>{if(t.hit)return void("none"!==t.el.style.display&&(t.el.style.display="none"));const a=t.time-e,n=(TRIGGER_Y-a*CFG.speed)/h*100;n>-10&&n<110?(t.el.style.display="block",t.el.style.top=`${n}%`,Math.abs(a-CFG.offset)<=HIT_WINDOW?(t.el.style.borderColor="#fff",t.el.style.boxShadow="0 0 15px #fff",t.el.style.transform="translate(-50%, -50%) scale(1.1)"):(t.el.style.borderColor="#fff",t.el.style.boxShadow="0 0 5px rgba(0,0,0,0.5)",t.el.style.transform="translate(-50%, -50%) scale(1)")):t.el.style.display="none"})),chartData.length>0&&e>chartData[chartData.length-1].time+2&&("test_game"===gameState?stopGameForTestResult():(isPlaying=!1,alert("Song Complete! Final Score: "+score),score=0,combo=0,location.reload()))}requestAnimationFrame((()=>loop(e)))}c.onclick=e=>{AUDIO.init();const t=c.getBoundingClientRect();if("calibration"!==gameState)return;let a=e.clientX-t.left,n=e.clientY-t.top,o=w-Math.floor(a/t.width*w),r=Math.floor(n/t.height*h);o=Math.max(0,Math.min(w-1,o)),r=Math.max(0,Math.min(h-1,r));const i=ctx.getImageData(o,r,1,1).data,s={r:i[0],g:i[1],b:i[2]};const l=`rgb(${s.r},${s.g},${s.b})`,d=document.getElementById("target-swatch");d&&(d.style.background=l),[0,2].forEach((e=>{trackers[e].color=s,trackers[e].active=!0;const t=document.getElementById("z"+e);t&&(t.style.borderColor=l)})),isPlaying||AUDIO.playCymbal(AUDIO.ctx.currentTime)};</script>